#!/bin/bash

# Configuration
IMAGE_NAME="docker-dtr.nordicsemi.no/sw-production/ncs-test:latest"
VOLUME_NAME="docker-python-packages"
PACKAGES_PATH="/usr/local/lib/python3.12/site-packages/"
CONTAINER_NAME="ncs-test-temp"
SYMLINK_PATH="$HOME/container-packages"

echo "üîÑ Pulling latest image..."
docker pull $IMAGE_NAME
IMAGE_VER=$(docker image inspect --format '{{json .Config.Labels.VER}}' $IMAGE_NAME)

echo "üõë Stopping old container if running..."
docker stop $CONTAINER_NAME

echo "üóëÔ∏è  Removing old volume..."
docker volume rm $VOLUME_NAME

echo "üì¶ Starting container..."
docker run -d --rm \
  --name $CONTAINER_NAME \
  -v $VOLUME_NAME:$PACKAGES_PATH \
  $IMAGE_NAME \
  tail -f /dev/null

echo "üîó Getting volume mount path..."
MOUNT_PATH=$(docker volume inspect $VOLUME_NAME --format='{{.Mountpoint}}')

echo "üîó Creating symlink..."
if [ -L "$SYMLINK_PATH" ]; then
  rm $SYMLINK_PATH
fi
ln -s $MOUNT_PATH $SYMLINK_PATH

echo "‚úÖ Done!"
echo ""
echo "Image version: ${IMAGE_VER//\"/}"
echo "Volume: $VOLUME_NAME"
echo "Mount point: $MOUNT_PATH"
echo "Symlink: $SYMLINK_PATH"
echo ""
echo "Configure Pyright with:"
echo '  "extraPaths": ["~/container-packages"]'
